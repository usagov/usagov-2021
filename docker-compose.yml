version: '3.0'
services:
  cms:
    container_name: cms
    image: ednark/usagov-2021:cms-latest
    build:
      context: ./
      dockerfile: .docker/Dockerfile-cms
    ports:
      - 80:80
      - 443:443
    networks:
      gsa-gov:
        aliases:
          - www-usagov.docker.local
          - beta-usagov.docker.local
          - cms-usagov.docker.local
    volumes:
      - ./html:/var/www/html:delegated
      - ./files:/var/www/files:delegated
      - ./config:/var/www/config:delegated
      - ./libraries:/var/www/libraries:delegated
      - ./modules/custom:/var/www/web/modules/custom:delegated
      - ./themes/custom:/var/www/web/themes/custom:delegated
      - ./scripts:/var/www/scripts:delegated
      - ./patches:/var/www/patches:delegated
      - ./composer.json:/var/www/composer.json
      - ./composer.lock:/var/www/composer.lock
      - ./settings/settings.php:/var/www/web/sites/default/settings.php
      - ./settings/settings.local.php:/var/www/web/sites/default/settings.local.php
      - ./settings/settings.cf.php:/var/www/web/sites/default/settings.cf.php
      - ./.docker/src-cms/etc/nginx/nginx.conf.tmpl:/etc/nginx/nginx.conf.tmpl
      - ./.docker/src-cms/etc/nginx/conf.d/default.conf.tmpl:/etc/nginx/conf.d/default.conf.tmpl
      - ./.docker/src-cms/etc/nginx/conf.d:/etc/nginx/conf.d:delegated
      - ./.docker/src-cms/etc/nginx/partials/drupal.conf:/etc/nginx/partials/drupal.conf:delegated
      - ./.docker/src-cms/etc/nginx/partials/php.conf:/etc/nginx/partials/php.conf:delegated
      - ./.docker/src-cms/etc/nginx/partials/ssl.conf:/etc/nginx/partials/ssl.conf:delegated
      - ./.docker/src-cms/etc/nginx/partials:/etc/nginx/partials:delegated
      #- ./.docker/src-cms/50_xdebug.ini:/etc/php8/conf.d/50_xdebug.ini:delegated
    env_file:
      - ./env.local
    environment:
      COMPOSER_MEMORY_LIMIT: -1
      S3_HOST: minio:9000
      S3_PROXY: minio:9000/web
      CF_INSTANCE_INDEX: '1'
      VCAP_APPLICATION: >
        {"name": "cms", "application_id": "docker","application_uris":["www-usagov.docker.local","cms-usagov.docker.local"]}
      VCAP_SERVICES: >
        { "s3": [{
            "name": "storage",
            "credentials": {
              "access_key_id": "minioadmin",
              "secret_access_key": "miniopass",
              "region": "us-west-1",
              "bucket": "web",
              "hostname": "minio:9000"
            }
          }],
          "aws-rds": [{
            "name": "database",
            "credentials": {
              "db_name": "drupal",
              "host": "database",
              "password": "mysql",
              "port": "3306",
              "username": "root"
            }
          }],
          "user-provided": [{
            "name": "secrets",
            "credentials": {
              "ADMIN_EMAIL": "secret@example.com",
              "CRON_KEY": "SECRET",
              "HASH_SALT": "SECRET",
              "ROOT_USER_NAME": "root",
              "ROOT_USER_PASS": "root"
            }
          }]
        }
    depends_on:
      - database

  database:
    container_name: database
    build:
      context: ./
      dockerfile: .docker/Dockerfile-mysql
    ports:
      - 3306:3306
    volumes:
      - .:/app:delegated
      - database_data:/var/lib/mysql:delegated
    environment:
      MYSQL_ROOT_PASSWORD: mysql
      MYSQL_DATABASE: drupal
    cap_add:
      - SYS_NICE
    networks:
      - gsa-gov

  minio:
    container_name: minio
    build:
      context: ./
      dockerfile: .docker/Dockerfile-minio
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - ./s3:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=miniopass
    networks:
      - gsa-gov

  composer:
    container_name: composer
    build:
      context: ./
      dockerfile: .docker/Dockerfile-cms
      target: composer-builder
    #command: tail -f /dev/null
    command: echo "Shutting Down on Purpose"
    volumes:
      - ./composer.json:/var/www/composer.json:delegated
      - ./composer.lock:/var/www/composer.lock:delegated
      - ./patches:/var/www/patches:delegated
      - ./libraries:/var/www/libraries:delegated
      - ./vendor:/var/www/vendor:delegated
      - ./web:/var/www/web:delegated
      - ./themes/custom:/var/www/web/themes/custom:delegated
      - ./modules/custom:/var/www/web/modules/custom:delegated
    env_file:
      - ./env.local

  node:
    container_name: node
    build:
      context: ./
      dockerfile: .docker/Dockerfile-cms
      target: theme-builder
    command: npm run watch --prefix /var/www/web/themes/custom/usagov
    #command: echo "Shutting Down on Purpose"
    volumes:
      - ./themes/custom:/var/www/web/themes/custom:delegated
    env_file:
      - ./env.local
    networks:
      - gsa-gov

volumes:
  database_data:

networks:
  gsa-gov:

  # waf:
  #   container_name: waf
  #   image: ednark/usagov-2021:waf-latest
  #   build:
  #     context: .docker/
  #     dockerfile: Dockerfile-waf
  #   ports:
  #     - 8080:80
  #   depends_on:
  #     - minio
  #   networks:
  #     - gsa-gov
  #   environment:
  #     - SERVERNAME=localhost
  #     - PORT=443
  #     - APP_NAME=USAGov
  #     - BLOCKED_NAME=USAGov
  #     # - IP_ALLOWED=50.81.160.164 100.36.151.190 52.222.122.97/32 52.222.123.172/32 159.142.0.0/16
  #     #############################################
  #     # CRS Variables
  #     #############################################
  #     # Paranoia Level
  #     - PARANOIA=1
  #     # Inbound and Outbound Anomaly Score Threshold
  #     - ANOMALY_INBOUND=5
  #     - ANOMALY_OUTBOUND=4
  #     # Executing Paranoia Level
  #     # - EXECUTING_PARANOIA=2
  #     #######################################################
  #     # Reverse Proxy mode
  #     # (only available if SETPROXY was enabled during the
  #     # parent ModSecurity image)
  #     #######################################################
  #     # PROXYLOCATION: Application Backend of Reverse Proxy
  #     # - PROXYLOCATION=http://app:8000/
  #     #
  #     # If needed: add own httpd-proxy.conf (only available if SETPROXY
  #     # was enabled during build of parent ModSecurity image)
  #     #  - ./httpd-proxy.conf:/usr/local/apache2/conf/extra/httpd-proxy.conf
  #     #######################################################
  #     # Various CRS Variables with Default Values
  #     #######################################################
  #     #- ENFORCE_BODYPROC_URLENCODED=1
  #     #- ALLOWED_METHODS=GET HEAD POST OPTIONS
  #     #- ALLOWED_REQUEST_CONTENT_TYPE=application/x-www-form-urlencoded|multipart/form-data|text/xml|application/xml|application/soap+xml|application/x-amf|application/json|application/octet-stream|text/plain
  #     #- ALLOWED_REQUEST_CONTENT_TYPE_CHARSET=utf-8|iso-8859-1|iso-8859-15|windows-1252
  #     #- ALLOWED_HTTP_VERSIONS=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0
  #     #- RESTRICTED_EXTENSIONS=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .resources/ .resx/ .sql/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/
  #     #- RESTRICTED_HEADERS=/proxy/ /lock-token/ /content-range/ /if/
  #     #- STATIC_EXTENSIONS=/.jpg/ /.jpeg/ /.png/ /.gif/ /.js/ /.css/ /.ico/ /.svg/ /.webp/
  #     #######################################################
  #     # CRS Variables with Default Value unlimited
  #     #######################################################
  #     #- MAX_NUM_ARGS=255
  #     #- ARG_NAME_LENGTH=100
  #     #- ARG_LENGTH=400
  #     #- TOTAL_ARG_LENGTH=64000
  #     #- MAX_FILE_SIZE=1048576
  #     #- COMBINED_FILE_SIZES=1048576
  #     #######################################################
  #     # Volumes for ModSecurity Tuning
  #     #######################################################
  #     # volumes:
  #     #   - ./src-waf/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf:/etc/modsecurity.d/owasp-crs/rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf
  #     #   - ./src-waf/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf:/etc/modsecurity.d/owasp-crs/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf
  #     #######################################################
  #     # Add TLS server certificate and key
  #     # (only available if SETPROXY was enabled during the
  #     # parent ModSecurity image)
  #     #######################################################
  #     #  - ./server.crt:/usr/local/apache2/conf/server.crt
  #     #  - ./server.key:/usr/local/apache2/conf/server.key
