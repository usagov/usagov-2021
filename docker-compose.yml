version: '3.0'
services:
  # cms:
  #   container_name: cms
  #   image: ednark/usagov-2021:cms-latest
  #   build:
  #     context: ./
  #     dockerfile: .docker/Dockerfile-cms
  #   ports:
  #     - 8080:80
  #     - 9090:9000
  #   volumes:
  #     - ./config:/var/www/config:delegated
  #     - ./libraries:/var/www/libraries:delegated
  #     - ./modules/custom:/var/www/web/modules/custom:delegated
  #     - ./themes/custom:/var/www/web/themes/custom:delegated
  #     - ./scripts:/var/www/scripts:delegated
  #     - ./composer.json:/var/www/composer.json
  #     - ./composer.lock:/var/www/composer.lock
  #     - ./settings/settings.php:/var/www/web/sites/default/settings.php
  #     - ./settings/settings.local.php:/var/www/web/sites/default/settings.local.php
  #     - ./settings/settings.cf.php:/var/www/web/sites/default/settings.cf.php
  #   env_file:
  #     - ./env.local
  #   environment:
  #     COMPOSER_MEMORY_LIMIT: -1
  #     CF_INSTANCE_INDEX: '1'
  #     VCAP_APPLICATION: >
  #       {"name": "cms", "application_id": "docker"}
  #     VCAP_SERVICES: >
  #       { "s3": [{
  #           "name": "storage",
  #           "credentials": {
  #             "access_key_id": "minioadmin",
  #             "secret_access_key": "minioadmin",
  #             "region": "us-west-1",
  #             "bucket": "web",
  #             "hostname": "minio:9000"
  #           }
  #         }],
  #         "aws-rds": [{
  #           "name": "database",
  #           "credentials": {
  #             "db_name": "drupal",
  #             "host": "database",
  #             "password": "mysql",
  #             "port": "3306",
  #             "username": "root"
  #           }
  #         }],
  #         "user-provided": [{
  #           "name": "secrets",
  #           "credentials": {
  #             "ADMIN_EMAIL": "secret@example.com",
  #             "CRON_KEY": "SECRET",
  #             "HASH_SALT": "SECRET",
  #             "ROOT_USER_NAME": "root",
  #             "ROOT_USER_PASS": "root"
  #           }
  #         }]
  #       }
  #   depends_on:
  #     - database
  #   networks:
  #     - gsa-gov

  # database:
  #   container_name: database
  #   build:
  #     context: ./
  #     dockerfile: .docker/Dockerfile-mysql
  #   ports:
  #     - 3306:3306
  #   volumes:
  #     - .:/app:delegated
  #     - database_data:/var/lib/mysql:delegated
  #   environment:
  #     MYSQL_ROOT_PASSWORD: mysql
  #     MYSQL_DATABASE: drupal
  #   networks:
  #     - gsa-gov

  # composer:
  #   container_name: composer
  #   build:
  #     context: ./
  #     dockerfile: .docker/Dockerfile-cms
  #     target: composer-builder
  #   command: echo "Shutting Down on Purpose"
  #   volumes:
  #     - .:/var/www:delegated
  #   env_file:
  #     - ./env.local

  # node:
  #   container_name: node
  #   build:
  #     context: ./
  #     dockerfile: .docker/Dockerfile-cms
  #     target: theme-builder
  #   #command: npm run watch --prefix /var/www/web/themes/custom/usagov
  #   command: echo "Shutting Down on Purpose"
  #   volumes:
  #     - .:/var/www:delegated
  #   env_file:
  #     - ./env.local
  #   networks:
  #     - gsa-gov

  # web:
  #   container_name: web
  #   build:
  #     context: ./
  #     dockerfile: .docker/Dockerfile-web
  #   ports:
  #     - 81:80
  #   environment:
  #     - S3_PROXY=minio:9000/web
  #     - CMS_PROXY=cms
  #     - ALLOWED_IPS="allow all; satisfy all;"
  #   depends_on:
  #     - minio
  #     - cms
  #   networks:
  #     - gsa-gov

  # minio:
  #   container_name: minio
  #   build:
  #     context: ./
  #     dockerfile: .docker/Dockerfile-minio
  #   ports:
  #     - 9000:9000
  #     - 9001:9001
  #   volumes:
  #     - ./s3:/data
  #   networks:
  #     - gsa-gov

  waf:
    container_name: waf
    image: ednark/usagov-2021:waf-latest
    build:
      context: .docker/
      dockerfile: Dockerfile-waf
    ports:
      # only available if SETTLS was enabled:
      - 443:443
      - 80:80
    environment:
      - S3_PROXY=minio:9000/web
      - CMS_PROXY=cms
      - SERVERNAME=localhost
      - PORT=443
      - APP_NAME=USAGov
      - BLOCKED_NAME=USAGov
      #- IP_ALLOWED_HEALTH=allow 52.222.122.97/32;\n\tallow 52.222.123.172/32;\n\tallow 50.81.160.164;
      #- IP_ALLOWED=allow 50.81.160.164;\n\tallow 100.36.151.190;\n\tallow 52.222.122.97/32;\n\tallow 52.222.123.172/32;\n\tallow 159.142.0.0/16;
      - IP_ALLOWED="50.81.160.164 100.36.151.190 52.222.122.97/32 52.222.123.172/32 159.142.0.0/16"

      #############################################
      # CRS Variables
      #############################################
      # Paranoia Level
      - PARANOIA=1
      # Inbound and Outbound Anomaly Score Threshold
      - ANOMALY_INBOUND=5
      - ANOMALY_OUTBOUND=4
      # Executing Paranoia Level
      # - EXECUTING_PARANOIA=2

      #######################################################
      # Reverse Proxy mode
      # (only available if SETPROXY was enabled during the
      # parent ModSecurity image)
      #######################################################
      # PROXYLOCATION: Application Backend of Reverse Proxy
      # - PROXYLOCATION=http://app:8000/
      #
      # If needed: add own httpd-proxy.conf (only available if SETPROXY
      # was enabled during build of parent ModSecurity image)
      #  - ./httpd-proxy.conf:/usr/local/apache2/conf/extra/httpd-proxy.conf

      #######################################################
      # Various CRS Variables with Default Values
      #######################################################
      #- ENFORCE_BODYPROC_URLENCODED=1
      #- ALLOWED_METHODS=GET HEAD POST OPTIONS
      #- ALLOWED_REQUEST_CONTENT_TYPE=application/x-www-form-urlencoded|multipart/form-data|text/xml|application/xml|application/soap+xml|application/x-amf|application/json|application/octet-stream|text/plain
      #- ALLOWED_REQUEST_CONTENT_TYPE_CHARSET=utf-8|iso-8859-1|iso-8859-15|windows-1252
      #- ALLOWED_HTTP_VERSIONS=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0
      #- RESTRICTED_EXTENSIONS=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .resources/ .resx/ .sql/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/
      #- RESTRICTED_HEADERS=/proxy/ /lock-token/ /content-range/ /if/
      #- STATIC_EXTENSIONS=/.jpg/ /.jpeg/ /.png/ /.gif/ /.js/ /.css/ /.ico/ /.svg/ /.webp/

      #######################################################
      # CRS Variables with Default Value unlimited
      #######################################################
      #- MAX_NUM_ARGS=255
      #- ARG_NAME_LENGTH=100
      #- ARG_LENGTH=400
      #- TOTAL_ARG_LENGTH=64000
      #- MAX_FILE_SIZE=1048576
      #- COMBINED_FILE_SIZES=1048576

    #######################################################
    # Volumes for ModSecurity Tuning
    #######################################################
    volumes:
      - ./REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf:/etc/modsecurity.d/owasp-crs/rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf
      - ./RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf:/etc/modsecurity.d/owasp-crs/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf
    #######################################################
    # Add TLS server certificate and key
    # (only available if SETPROXY was enabled during the
    # parent ModSecurity image)
    #######################################################
    #  - ./server.crt:/usr/local/apache2/conf/server.crt
    #  - ./server.key:/usr/local/apache2/conf/server.key

volumes:
  database_data:

networks:
  gsa-gov:
