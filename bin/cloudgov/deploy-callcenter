#!/usr/bin/env bash

# we might be running in circleci
if [ -f /home/circleci/project/env.local ]; then
  . /home/circleci/project/env.local
fi
# we might be running from a local dev machine
SCRIPT_DIR="$(dirname "$0")"
if [ -f $SCRIPT_DIR/env.local ]; then
  . $SCRIPT_DIR/env.local
fi
if [ -f ./env.local ]; then
  . ./env.local
fi
if [ -f $SCRIPT_DIR/../deploy/includes ]; then
  . $SCRIPT_DIR/../deploy/includes
else
   echo Cannot find $SCRIPT_DIR/../deploy/includes
   exit 1
fi

# just testing?
if [ x$1 = x"--dryrun" ]; then
  export echo=echo
  shift
fi

SPACE=${1:-please-provide-space-name-as-first-argument}
SPACE=$(echo "$SPACE" | tr '[:upper:]' '[:lower:]')
assertCurSpace $SPACE
shift
ORG=$(getOrg)

DOCKERUSER=${DOCKERUSER:-gsatts}
DOCKERREPO=${DOCKERREPO:-usagov-2021}

export APPNAME="callcenter"

assertRequires 'jq'

function setHTTPProxy() {
    appSpace=$1
    appName=$2
    proxySet=$3
    proxySpace=$CF_EGRESS_SPACE
    proxyName="${SPACE}-proxy"
    if [ "$proxySet" = "1" ]; then
        echo "Setting http_proxy to $proxyName"
        cf target -s $proxySpace -o $CF_EGRESS_ORG > /dev/null 2>&1;
        proxyroute=$(cf env $proxyName | grep proxy_route | awk '{print $2}')
        if [ -z "$proxyroute" ]; then
            echo "ERROR: $proxyName does not have a proxy_route set"
            exit 1
        fi;
        cf target -s $appSpace -o $ORG > /dev/null 2>&1
        cf set-env $appName https_proxy $proxyroute
        cf set-env $appName HTTPS_PROXY $proxyroute
        cf set-env $appName http_proxy $proxyroute
        cf set-env $appName HTTP_PROXY $proxyroute
    elif [ "$proxySet" = "0" ]; then
        echo "Setting http_proxy to empty"
        cf target -s $appSpace -o $ORG > /dev/null 2>&1
        cf unset-env $appName https_proxy
        cf unset-env $appName HTTPS_PROXY
        cf unset-env $appName http_proxy
        cf unset-env $appName HTTP_PROXY
    fi;
}

function setCallCenterEnv() {
  appSpace=$1
  appName=$2

  if [ -z "$CALL_CENTER_ENVIRONMENT" \
    -o -z "$CALL_CENTER_CLIENT_ID" \
    -o -z "$CALL_CENTER_EN_QUEUE_ID" \
    -o -z "$CALL_CENTER_CLIENT_SECRET" \
    -o -z "$CALL_CENTER_SP_QUEUE_ID" ]; then
    echo CALL_CENTER environment variables not set.  Check env.local and redeploy
    exit 1
  fi

  cf target -s $appSpace -o $ORG > /dev/null 2>&1
  cf set-env $appName CALL_CENTER_ENVIRONMENT   $CALL_CENTER_ENVIRONMENT
  cf set-env $appName CALL_CENTER_CLIENT_ID     $CALL_CENTER_CLIENT_ID
  cf set-env $appName CALL_CENTER_CLIENT_SECRET $CALL_CENTER_CLIENT_SECRET
  cf set-env $appName CALL_CENTER_EN_QUEUE_ID   $CALL_CENTER_EN_QUEUE_ID
  cf set-env $appName CALL_CENTER_SP_QUEUE_ID   $CALL_CENTER_SP_QUEUE_ID
}

function cf_push() {
  appspec=$1
  if [ -z "$DOCKERHUB_ACCESS_TOKEN" ]; then
    cf push ${APPNAME} --docker-image ${appspec}
  else
    CF_DOCKER_PASSWORD=$DOCKERHUB_ACCESS_TOKEN cf push ${APPNAME} --docker-image ${appspec} --docker-username $DOCKERHUB_USERNAME
  fi
}

# launch the app
APPSPEC=${DOCKERUSER}/${DOCKERREPO}:${APPNAME}
echo "Deploying ${APPSPEC}"

if existsCFService ${APPNAME}-service-account; then
  echo "User service ${APPNAME}-service-account already exists - good!"
else
  $SCRIPT_DIR/create-service-account $SPACE $APPNAME
fi

if existsCFService ${APPNAME}-service-account; then
  SERVICE_KEY=$(cf service-key ${APPNAME}-service-account ${APPNAME}-service-key | tail -n +3)
  SERVICE_USER=$( echo ${SERVICE_KEY} | jq -r '.credentials.username')
  $echo cf unset-space-role ${SERVICE_USER} $ORG $SPACE SpaceDeveloper
else
  echo could not create Service Account for ${APPNAME} in ${SPACE}
  exit 1
fi

if existsCFApp ${APPNAME} ; then
  $SCRIPT_DIR/setup-egress-for-apps --no-restart ${APPNAME}
  setHTTPProxy ${SPACE} ${APPNAME} 1
  setCallCenterEnv ${SPACE} ${APPNAME}
  cf_push $APPSPEC
else
  cf_push $APPSPEC
  setHTTPProxy ${SPACE} ${APPNAME} 1
  setCallCenterEnv ${SPACE} ${APPNAME}
  $SCRIPT_DIR/setup-egress-for-apps --no-restart ${APPNAME}
fi
