#!/bin/bash

RED='\033[0;31m'
NC='\033[0m' # No Color

echo "get s3 access"
# source bin/cloudgov/get-s3-access storage >/dev/null 2>&1
echo "get latest backup tag from s3.  this will take awhile."
# DEPLOY_TAG=$(aws s3 ls --recursive $S3_BUCKET/web-backup/ | sort | tail -n 1 | awk '{split($4, array, "/"); print array[2]}')
DEPLOY_TAG="USAGOV-1804.prod.10462.post-deploy" # temp for testing
echo "DEPLOY_TAG: $DEPLOY_TAG"
echo "downloading static site. also will take awhile"
# aws s3 cp --only-show-errors s3://$S3_BUCKET/web-backup/$DEPLOY_TAG $DEPLOY_TAG --recursive
count=$(find $DEPLOY_TAG -type f | wc -l)
echo "File count: $count"
echo "get three random html files for testing"
for i in {1..3}; do
  filepath=$(find $DEPLOY_TAG -type f -name "*.html" | shuf -n 1)
  echo "Testing file $i: $filepath"

  tmp=$(mktemp)
  tidy -qe "$filepath" &> "$tmp"
  if [ $? -eq 0 ]; then
    echo "Valid HTML!"
  else
    echo -e "\033[0;31mHTML is invalid, output:"
    cat "$tmp"
    echo -e "\033[0m"
  fi
  rm "$tmp"

done

echo "done"