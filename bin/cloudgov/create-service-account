#!/bin/bash

usage="
$0: Creates a service account for each space.

Usage:
   $0 -h

Options:
-h:            show help and exit

REQUIREMENTS:
Must be an OrgManager to have the permissions required for this script to work.
"

PREAMBLE=$(sed -E 's/bin\/.*\/includes/bin\/includes/g' <<< "$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )/includes/preamble.sh")
if [ -f "$PREAMBLE" ]; then
  # shellcheck source=bin/includes/preamble.sh
  . "$PREAMBLE"
else
   echo Cannot find preamble at "$PREAMBLE"
   exit 1
fi

if ! command -v cf &> /dev/null
then
    echo "CF : the cloud foundry client could not be found and is required"
    exit
fi

startorg=$(   cf target | grep org:   | awk '{ print $2 }')

keyname="cci"
resetkey="false"

for var in "$@"
do
  if [ "$var" = "--reset-key" ]; then
    resetkey="resetkey"
  else
    keyname="$var"
  fi
done
resetkey=${1:-}

cf create-service cloud-gov-service-account space-deployer cci-service-account

if [ "$resetkey" = "--reset-key" ]; then
  cf delete-service-key cci-service-account $keyname-service-key -f
fi

cf create-service-key cci-service-account $keyname-service-key

SERVICE_KEY=$(cf service-key cci-service-account $keyname-service-key | tail -n +3)
echo $SERVICE_KEY

SERVICE_USER=$(echo $SERVICE_KEY | jq -r '.username' )
cf set-space-role $SERVICE_USER $startorg dev SpaceDeveloper
cf set-space-role $SERVICE_USER $startorg stage SpaceDeveloper
cf set-space-role $SERVICE_USER $startorg prod SpaceDeveloper
cf set-space-role $SERVICE_USER $startorg shared-egress SpaceDeveloper
