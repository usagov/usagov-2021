#!/bin/bash

usage="
$0: Attempts to create a container image for egress proxy to be used when launching cloud.gov images.

Usage:
   $0 -h

Options:
-h:            show help and exit
DOCKERUSER:    Docker Hub username (default: gsatts [don't change this])
DOCKERREPO:    Docker Hub repo (default: usagov-2021 [don't change this])
CONTAINERTAG:  Git tag of the container being created (default: $GITBRANCH)
CONTAINERTAG2: Optional tag label

NOTES:
Arguments come from environment.
"

PREAMBLE=$(sed -E 's/bin\/.*\/includes/bin\/includes/g' <<< "$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )/includes/preamble.sh")
if [ -f "$PREAMBLE" ]; then
  # shellcheck source=bin/includes/preamble.sh
  . "$PREAMBLE"
else
   echo Cannot find preamble at "$PREAMBLE"
   exit 1
fi

DOCKERUSER=${DOCKERUSER:-gsatts}
DOCKERREPO=${DOCKERREPO:-usagov-2021}

GITBRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")
CONTAINERTAG=${1:-$GITBRANCH}

CONTAINERTAG2=${2}

if [ -z "$CONTAINERTAG" ]
then
      echo "Must specify a container tag to build"
      exit 1;
fi;

echo "Building ${DOCKERUSER}/${DOCKERREPO}:egress-${CONTAINERTAG} ${CONTAINERTAG2}"

docker build --force-rm \
    -t $DOCKERUSER/$DOCKERREPO:egress-$CONTAINERTAG \
    -f .docker/Dockerfile-egress .docker/src-egress

docker run --name egress-builder-tmp -d $DOCKERUSER/$DOCKERREPO:egress-$CONTAINERTAG tail -f /dev/null
docker cp egress-builder-tmp:/usr/bin/caddy .docker/src-egress/caddy
docker stop egress-builder-tmp
docker rm egress-builder-tmp
