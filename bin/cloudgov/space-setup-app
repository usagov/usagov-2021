#!/usr/bin/env bash

APP_SPACE=${1:-dev-restricted}
ORG=gsa-tts-usagov

# create space
if cf space $APP_SPACE > /dev/null 2>&1; then
  echo "space $APP_SPACE already exists"
else
  echo "Create app space $APP_SPACE"
  echo "cf create-space $APP_SPACE"
fi

# create service account
if cf service cloud-gov-service-account | grep cloud-gov-service-account | grep cci-${APP_SPACE}-service-account > /dev/null 2>&1; then
  echo "service-account cci-${APP_SPACE}-service-account already exists"
else
  echo "create service-account cci-${APP_SPACE}-service-account"
  echo "cf create-service cloud-gov-service-account space-deployer cci-${APP_SPACE}-service-account"
  echo "cf create-service-key cci-${APP_SPACE}-service-account cci-${APP_SPACE}-service-key"
  echo "cf service-key cci-${APP_SPACE}-service-account cci-${APP_SPACE}-service-key"
fi

# setup asg network for staging lifecycle
STAGING_SECURITY_GROUPS="public_networks dns trusted_local_networks public_networks_egress trusted_local_networks_egress"
for SECURITY_GROUP in $STAGING_SECURITY_GROUPS; do
  if cf security-groups | grep $APP_SPACE | grep -e 'staging$' | grep -e '^'$SECURITY_GROUP'[[:space:]]' > /dev/null 2>&1; then
    echo "$SECURITY_GROUP already bound to $APP_SPACE during 'staging' lifecycle"
  else
    echo "bind $SECURITY_GROUP to $APP_SPACE during 'staging' lifecycle"
    echo "cf bind-security-group $SECURITY_GROUP $ORG --space $APP_SPACE --lifecycle staging"
  fi
done

# setup asg network for running lifecycle
RUNNING_SECURITY_GROUPS="trusted_local_networks_egress dns"
for SECURITY_GROUP in $RUNNING_SECURITY_GROUPS; do
  if cf security-groups | grep $APP_SPACE | grep -e 'running$' | grep -e '^'$SECURITY_GROUP'[[:space:]]' > /dev/null 2>&1; then
    echo "$SECURITY_GROUP already bound to $APP_SPACE during 'running' lifecycle"
  else
    echo "bind $SECURITY_GROUP to $APP_SPACE during 'running' lifecycle"
    echo "cf bind-security-group $SECURITY_GROUP $ORG --space $APP_SPACE --lifecycle running"
  fi
done
