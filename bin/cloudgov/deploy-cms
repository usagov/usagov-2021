#!/usr/bin/env bash

usage="
$0: Attempts to deploy a CMS app by tag.

Usage:
   $0 -h
   $0 CTAG
   $0 CTAG CDIGEST

Options:
-h:            show help and exit
DOCKERUSER:    Docker Hub user (default: gsatts)
DOCKERREPO:    Docker Hub repo (default: usagov-2021)
CTAG:          Docker container tag (default: latest)
CDIGEST:       Container digest

NOTES:
Docker user and pass arguments come from environment.
"

PREAMBLE=$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"/includes/preamble.sh"
if [ -f "$PREAMBLE" ]; then
  # shellcheck source=bin/includes/preamble.sh
  . "$PREAMBLE"
else
   echo Cannot find preamble at "$PREAMBLE"
   exit 1
fi

DOCKERUSER=${DOCKERUSER:-gsatts}
DOCKERREPO=${DOCKERREPO:-usagov-2021}
CTAG=${1:-latest}
CDIGEST=${2:-}

APP_SPACE=$( cf target | grep space: | awk '{ print $2 }')
APP_ORG=$(   cf target | grep org:   | awk '{ print $2 }')

# The Image digest for this tag should be looked up from cloud.gov storage
# Any tag with a stored Image digest should be referenced by hash instead of tag

function appExists {  # appname
  app=$1
  if [ -z "$app" ]; then
    echo "ERROR: appname is required"
    exit 1
  fi
  echo cf app $app > /dev/null 2>&1
  cf app $app > /dev/null 2>&1
  return $?
}

function restartApp { #appname
  app=$1
  if [ -z "$app" ]; then
    echo "ERROR: appname is required"
    exit 1
  fi
  cf restart $app --no-wait --strategy rolling
}

function pushApp { #appname
  app=$1
  if [ -z "$app" ]; then
    echo "ERROR: appname is required"
    exit 1
  fi

  instances="-i 1"
  if [ "$APP_SPACE" == "prod" ]; then
    instances="-i 2"
  elif [ "$APP_SPACE" == "stage" ]; then
    instances="-i 1"
  elif [ "$APP_SPACE" == "dev" ]; then
    instances="-i 1"
  fi

  if [ -z "$CDIGEST" ]; then
    echo "Deploying ${DOCKERUSER}/${DOCKERREPO}:${app}-${CTAG}"
    cf push $app $instances --docker-image ${DOCKERUSER}/${DOCKERREPO}:${app}-${CTAG}
  else
    echo "Deploying ${DOCKERUSER}/${DOCKERREPO} ${app}-${CTAG} via digest ${CDIGEST}"
    cf push $app $instances --docker-image ${DOCKERUSER}/${DOCKERREPO}${CDIGEST}
  fi
}

function setupRoutes { #appname
  app=$1
  if [ -z "$app" ]; then
    echo "ERROR: appname is required"
    exit 1
  fi
  # the egress-setup doesn't interfere with bootstrapping
  # but cms needs to exist in the first place
  # for route mapping and egress setup to run

  cf create-route apps.internal --hostname cms-$APP_SPACE-usagov
  cf map-route $app apps.internal --hostname cms-$APP_SPACE-usagov
  cf create-route apps.internal --hostname beta-$APP_SPACE-usagov
  cf map-route $app apps.internal --hostname beta-$APP_SPACE-usagov

  if [ "$APP_SPACE" == "prod" ]; then
    cf create-route apps.internal --hostname www-$APP_SPACE-usagov
    cf map-route $app apps.internal --hostname www-$APP_SPACE-usagov
    cf create-route usa.gov --hostname cms
    cf map-route $app usa.gov --hostname cms
    cf create-route usa.gov --hostname beta
    cf map-route $app usa.gov --hostname beta
    cf create-route usa.gov --hostname www
    cf map-route $app usa.gov --hostname www

  else
    cf create-route usa.gov --hostname cms-$APP_SPACE
    cf map-route $app usa.gov --hostname cms-$APP_SPACE
    cf create-route usa.gov --hostname beta-$APP_SPACE
    cf map-route $app usa.gov --hostname beta-$APP_SPACE

  fi
}

function setupEgress { #appname
  app=$1
  if [ -z "$app" ]; then
    echo "ERROR: appname is required"
    exit 1
  fi
  $SCRIPT_DIR/setup-egress-for-apps $app --no-restart
}

function setupNewrelic { #appname
  app=$1
  if [ -z "$app" ]; then
    echo "ERROR: appname is required"
    exit 1
  fi
  $SCRIPT_DIR/setup-newrelic-for-apps $app --no-restart
}

if appExists cms; then
  setupRoutes cms
#  setupEgress cms
  setupNewrelic cms
  pushApp cms
else
  cf set-env cms SKIP_DRUPAL_BOOTSTRAP "skip"
  pushApp cms
  setupRoutes cms
#  setupEgress cms
  setupNewrelic cms
  cf set-env cms SKIP_DRUPAL_BOOTSTRAP ""
  restartApp cms
fi
