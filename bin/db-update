#!/bin/bash

usage="
$0: Imports the contents of a local sql file to the local database.

Usage:
   $0 -h

Options:
-h:            show help and exit
LOCAL_PORT:    port that mysql is mapped to (default: 3306)
LOCAL_FILE:    the name of the local sql file to import
"

PREAMBLE=$(sed -E 's/bin\/.*\/includes/bin\/includes/g' <<< "$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )/includes/preamble.sh")
if [ -f "$PREAMBLE" ]; then
  # shellcheck source=bin/includes/preamble.sh
  . "$PREAMBLE"
else
   echo Cannot find preamble at "$PREAMBLE"
   exit 1
fi

isnum_Case() { case ${1#[-+]} in ''|.|*[!0-9.]*|*.*.*) return 1;; esac ;}

if isnum_Case "$1"
then
    LOCAL_PORT=$1
    LOCAL_FILE=${2:-usagov.sql}
else
    LOCAL_PORT=3306
    LOCAL_FILE=${1:-usagov.sql}
fi

echo "Importing database from $LOCAL_FILE"
docker compose exec \
  database \
  /bin/bash -c "sed -e 's/utf8mb4_0900_ai_ci/utf8mb4_unicode_ci/g' /app/$LOCAL_FILE | mysql --protocol=TCP -hlocalhost -P$LOCAL_PORT -uroot -pmysql drupal; mysql_upgrade --protocol=TCP -hlocalhost -P$LOCAL_PORT -uroot -pmysql"
