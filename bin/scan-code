#!/bin/sh

usage="
$0: Spins up snyk container and tests Drupal custom code.

Usage:
   $0 -h

Options:
-h:            show help and exit
"

PREAMBLE=$( pwd -P )/bin/includes/preamble.sh
if [ -f "$PREAMBLE" ]; then
  # shellcheck source=bin/includes/preamble.sh
  . "$PREAMBLE"
else
   echo Cannot find preamble at "$PREAMBLE"
   exit 1
fi

THRESHOLD=${1:-low}

# Explicitly turn off DOCKER_CONTENT_TRUST, as snyk are not signing their images.
docker run --disable-content-trust -it --rm \
    -e "SNYK_TOKEN=$SNYK_TOKEN" \
    -v "$(pwd)/scripts:/app/scripts" \
    -v "$(pwd)/web/modules/custom:/app/web/modules/custom" \
    -v "$(pwd)/web/themes/custom:/app/web/themes/custom" \
    -v "/tmp/nosuchdir:/app/web/modules/custom/usagov_directories/utility" \
  snyk/snyk:php snyk code test --severity-threshold=$THRESHOLD
