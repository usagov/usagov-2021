#!/bin/bash

# Setup environmental variables so current User and Group Ids are available at container build time
# spam out to a variety of possible files to cover common cases
echo "Setup BUID and BGID environmental variables"
export BUID=$(id -u)
export GUID=$(id -g)
if [ -f ~/.zshrc ] && ! grep -q 'export BUID=' ~/.zshrc; then
  echo "export BUID=\$(id -u)" >> ~/.zshrc
  echo "export BGID=\$(id -g)" >> ~/.zshrc
fi
if [ -f ~/.bashrc ] && ! grep -q "export BUID=" ~/.bashrc; then
  echo "export BUID=\$(id -u)" >> ~/.bashrc
  echo "export BGID=\$(id -g)" >> ~/.bashrc
fi
if [ -f ~/.bash_profile ] && ! grep -q "export BUID=" ~/.bash_profile; then
  echo "export BUID=\$(id -u)" >> ~/.bash_profile
  echo "export BGID=\$(id -g)" >> ~/.bash_profile
fi
if [ -f ~/.profile ] && ! grep -q "export BUID=" ~/.profile; then
  echo "export BUID=\$(id -u)" >> ~/.profile
  echo "export BGID=\$(id -g)" >> ~/.profile
fi


echo "Init local secrets file"
if [ ! -f env.local ]; then
  cp env.default env.local
fi

echo "Setup git hooks"
if [ ! -f .git/hooks/commit-msg ]; then
  cp .git.commit-msg .git/hooks/commit-msg
fi

echo "Build Containers"
bin/build

echo "Fix permissions inside Containers - this could take a long time"
docker compose run --rm --no-deps --workdir /var/www composer /var/www/bin/fix-perms-in-container

echo "Install Drupal modules"
bin/drush cr
bin/composer install --no-interaction --optimize-autoloader

echo "Build theme"
bin/npm install --legacy-peer-deps
bin/npm rebuild node-sass
bin/gulp build


echo "Init process complete"
