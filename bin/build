#!/bin/bash
set -e

usage="
$0: Builds CMS container.

Usage:
   $0 -h

Options:
-h:            show help and exit

If run locally, it will load the BUID and BGID from env.local.
"
if [[ "$1" == "-h" ]]; then
    echo "${usage}"
    exit 1
fi

if [ -f env.local ]; then
  . env.local
fi

docker compose build \
  --build-arg BUID=${BUID:-$(id -u)} \
  --build-arg BGID=${BGID:-$(id -g)} \
  --build-arg GITBRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "") \
  --build-arg GITCOMMIT=$(git rev-parse HEAD 2>/dev/null || echo "") \
  --build-arg GITTAG=$(git tag --points-at $(git rev-parse HEAD 2>/dev/null) | grep ^v | sort -rV | head -n 1 2>/dev/null || echo "") \
  $@
