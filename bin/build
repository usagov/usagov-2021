#!/bin/bash
set -e

usage="
$0: Builds CMS container.

Usage:
   $0 -h

Options:
-h:            show help and exit
"

PREAMBLE=$( pwd -P )/bin/includes/preamble.sh
if [ -f "$PREAMBLE" ]; then
  # shellcheck source=bin/includes/preamble.sh
  . "$PREAMBLE"
else
   echo Cannot find preamble at "$PREAMBLE"
   exit 1
fi

# If run locally, it will load the BUID and BGID from env.local.
docker compose build \
  --build-arg BUID=${BUID:-$(id -u)} \
  --build-arg BGID=${BGID:-$(id -g)} \
  --build-arg GITBRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "") \
  --build-arg GITCOMMIT=$(git rev-parse HEAD 2>/dev/null || echo "") \
  --build-arg GITTAG=$(git tag --points-at $(git rev-parse HEAD 2>/dev/null) | grep ^v | sort -rV | head -n 1 2>/dev/null || echo "") \
  --build-arg BUILD_ENV=${BUILD_ENV:-unspecified} \
  $@

echo "Adding the USPS credentials..."
if [ -n "${USPS_USERID}" ] && [ -n "${USPS_PASSWORD}" ]; then
    echo "const USPS_USERID = '${USPS_USERID}';" > ./web/themes/custom/usagov/scripts/usps-credentials.js
    echo "const USPS_PASSWORD = '${USPS_PASSWORD}';" >> ./web/themes/custom/usagov/scripts/usps-credentials.js
    echo "USPS credentials added successfully!"
else
    echo "No credentials found in the env."
    echo "const error = 'No credentials found in the env.'" > ./web/themes/custom/usagov/scripts/usps-credentials.js
fi

