#!/bin/sh

usage="
$0: Spins up snyk container and tests dependancies.

Usage:
   $0 -h
   $0 THRESHOLD

Options:
-h:            show help and exit
THRESHOLD:     severity threshold (default: low)
"

PREAMBLE=$(sed -E 's/bin\/.*\/includes/bin\/includes/g' <<< "$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )/includes/preamble.sh")
if [ -f "$PREAMBLE" ]; then
  # shellcheck source=bin/includes/preamble.sh
  . "$PREAMBLE"
else
   echo Cannot find preamble at "$PREAMBLE"
   exit 1
fi

THRESHOLD=${1:-low}

# snyk are not signing their images, so turn off DOCKER_CONTENT_TRUST here. 
docker run --disable-content-trust -it --rm \
    -e "SNYK_TOKEN=$SNYK_TOKEN" \
    -v "$(pwd)/composer.json:/app/composer.json" \
    -v "$(pwd)/composer.lock:/app/composer.lock" \
    -v "$(pwd)/web/themes/custom/usagov/package.json:/app/web/themes/custom/usagov/package.json" \
    -v "$(pwd)/web/themes/custom/usagov/package-lock.json:/app/web/themes/custom/usagov/package-lock.json" \
  snyk/snyk:php snyk test --severity-threshold=$THRESHOLD

