#!/usr/bin/env bash

# we might be running in circleci
if [ -f /home/circleci/project/env.local ]; then
  . /home/circleci/project/env.local
fi
# we might be running from a local dev machine
SCRIPT_DIR="$(dirname "$0")"
if [ -f $SCRIPT_DIR/env.local ]; then
  . $SCRIPT_DIR/env.local
fi
if [ -f ./env.local ]; then
  . ./env.local
fi
if [ -f $SCRIPT_DIR/../deploy/includes ]; then
  . $SCRIPT_DIR/../deploy/includes
else
   echo Cannot find $SCRIPT_DIR/../deploy/includes
   exit 1
fi

# just testing?
if [ x$1 = x"--dryrun" ]; then
  echo=echo
  dryrun=$1
  shift
fi

SPACE=${1:-please-provide-space-name-as-first-argument}
SPACE=${SPACE,,}
assertCurSpace $SPACE
shift

TAG=$1
SQLGZ=${TAG}.sql.gz
SQLZIP=${TAG}.sql.zip

$echo bin/snapshot-backups/db-dump-download $dryrun $SPACE $TAG

if [ -f $SQLGZ ]; then
   if [[ -n $(zcat -f ${SQLGZ} | head | grep 'SET NAMES utf8mb4') ]]; then
      if [[ -n $(zcat -f ${SQLGZ} | tail | grep 'Dump completed on' ) ]]; then
        $echo bin/snapshot-backups/db-dump-push-to-snapshot $dryrun $SPACE $TAG
        if [ $? != 0 ]; then
          echo "Could not push snapshot '$TAG' to $SPACE s3"
          exit 1
        else
          echo snapshotted $TAG
          echo "Attempting to clear local files:"
          rm -f ${TAG}*
          ls -l ${TAG}* &> /dev/null
          if [ "$?" != "0" ]; then
             echo "Error: Could not delete temporary files:"
             ls -l ${TAG}*
             exit 1
          fi
        fi
        exit 0
      else
        echo "SQL dump does not appear to be valid (no 'Dump completed on' string found on tail of file)"
      fi
   else
      echo "SQL dump does not appear to be valid (no 'SET NAMES utf8mb4' string found on head of file)"
   fi
fi
