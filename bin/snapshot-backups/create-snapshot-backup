#!/bin/sh

usage="
$0: Create s3 snapshot backup of current environment's static site and database.

Usage:
   $0 -h
   $1 Desired environment
   $2 Desired branch
   $3 Tag Suffix

Options:
-h:            show help and exit
"

PREAMBLE=$(sed -E 's/bin\/.*\/includes/bin\/includes/g' <<< "$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )/includes/preamble.sh")
if [ -f "$PREAMBLE" ]; then
  # shellcheck source=bin/includes/preamble.sh
  . "$PREAMBLE"
else
   echo Cannot find preamble at "$PREAMBLE"
   exit 1
fi

### 3 required arguments:
echo "=========================================================================================="
echo "Desired environment : $1"
echo "Desired branch      : $2"
echo "Tag Suffix          : $3"
echo

####
#### Static Site Backup
####
echo "=========================================================================================="
echo "Create snapshot backup of static site:"
bin/snapshot-backups/stw $dryrun $1 $2 $3 site-snapshot-create
echo "Download static site snapshot"
bin/snapshot-backups/stw $dryrun $1 $2 $3 site-snapshot-download
echo

### --- Not needed unless local changes are to be pushed to the working env
### --- (the tag will need to be provided in this case, rather than generated by stw):
### bin/snapshot-backups/site-folder-push-to-snapshot <tag>

echo "=========================================================================================="
echo "List static site backups present in S3:"
bin/snapshot-backups/site-snapshot-list ${dryrun}
echo

####
#### DB Backup
####
echo "=========================================================================================="
echo "Create and download database dump:"
bin/snapshot-backups/stw $dryrun $1 $2 $3 db-dump-download
echo

echo "=========================================================================================="
echo "Push database dump to S3:"
bin/snapshot-backups/stw $dryrun $1 $2 $3 db-dump-push-to-snapshot
echo

### --- not needed unless retreiving previous db snapshot
### bin/snapshot-backups/db-snapshot-download <tag>

echo "=========================================================================================="
echo "List database dumps present in S3:"
bin/snapshot-backups/db-snapshot-list ${dryrun}
