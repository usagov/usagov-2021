#!/bin/sh

usage="
$0: Creates a tag for snapshot scripts and runs the selected script.

Usage:
   $0 -h
   $0 SPACE BRANCH SUFFIX COMMAND

Options:
-h:        show help and exit
SPACE:     Space name to work on
BRANCH:    Arbitrary name, use deployment ticket number
SUFFIX:    either pre-deploy or post-deploy
COMMAND:   Name of script to run
"

PREAMBLE=$(printf "$( ( cd -- "$(dirname "$0")" >/dev/null 2>&1 || exit ) && pwd -P )/bin/includes/preamble.sh" | sed -E 's/bin\/.*\/includes/bin\/includes/g')
if [ -f "$PREAMBLE" ]; then
  # shellcheck source=bin/includes/preamble.sh
  . "$PREAMBLE"
else
  echo Cannot find preamble at "$PREAMBLE"
  exit 1
fi

SPACE=$1
BRANCH=$2
SUFFIX=$3
COMMAND=$4

if [ x$SPACE != x -a x$BRANCH != x -a x$SUFFIX != x -a x$COMMAND != x ]; then

   if [ ! -f $COMMAND -a ! -x $COMMAND ]; then
      COMMAND=${SCRIPT_DIR}/${COMMAND}
   fi

   if [ ! -f $COMMAND -a ! -x $COMMAND ]; then
      echo
      echo ERROR: "$COMMAND" not found
      exit 1
   fi

   if ! isSpaceSSHEnabled $SPACE; then
      enableSpaceSSH $SPACE
      if [ "$?" -ne "0" ]; then
         assertSpaceSSHEnabled $SPACE
      fi
   fi

   BACKUP_TAG=$(createSpaceAssertedBackupTag $SPACE $BRANCH $SUFFIX)
else
   echo
   echo "Usage: $0 <cf-space-name> <branch-name (use deployment ticket number)> <suffix (pre_deploy or post_deploy)> <script>"
   echo "       $0 dev USAGOV-787 pre_deploy"
   exit 1
fi

echo
echo "Running '$COMMAND' with tag:  $BACKUP_TAG"
echo
$echo ${COMMAND} $BACKUP_TAG
