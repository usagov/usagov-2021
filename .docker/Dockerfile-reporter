FROM node:20-alpine
USER root
COPY .docker/src-reporter .

RUN chmod +x /createreport.sh\
    && apk upgrade --update \
    && apk add --no-cache --virtual .persistent-deps \
       jq \
       bash \
       curl \
       nginx

# copy our nginx config over what the nginx package provided,
# remove the default.conf file, restart nginx ... then install
# the analytics-reporter: 
COPY .docker/src-reporter/etc/nginx/* /etc/nginx/

RUN rm /etc/nginx/http.d/default.conf \
    && cp /analytics-reporter/etc/nginx/nginx.conf /etc/nginx/nginx.conf \
    && cp /analytics-reporter/etc/nginx/httpd.d/proxy.conf /etc/nginx/http.d/proxy.conf \
    && /usr/sbin/nginx -s reload \
    && npm install -g analytics-reporter

WORKDIR /analytics-reporter
RUN npm install minimist
RUN npm install
WORKDIR /
CMD ["./createreport.sh"]