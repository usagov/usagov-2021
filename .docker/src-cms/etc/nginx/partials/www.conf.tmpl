
server {
    listen 80;

    server_name ${WWW_HOST};

    resolver ${DNS_SERVER} valid=5s ipv6=off;

    set_by_lua $request_uri_lowercase "return string.lower(ngx.var.uri)";

    proxy_hide_header Cache-Control;
    proxy_hide_header expires;
    add_header Cache-Control max-age=900;

    # X-Robots-Tag header to be removed from config on "prod" only!
    add_header X-Robots-Tag noindex;

    include /etc/nginx/partials/internal_redirects.conf;
    include /etc/nginx/partials/s3proxy.conf;
    include /etc/nginx/partials/404s.conf;
    include /etc/nginx/partials/staticsite.conf;
}

server {
    listen 443 ssl;
    include partials/ssl.conf;

    server_name ${WWW_HOST};

    resolver ${DNS_SERVER} valid=5s ipv6=off;

    set_by_lua $request_uri_lowercase "return string.lower(ngx.var.uri)";

    proxy_hide_header Cache-Control;
    proxy_hide_header expires;
    add_header Cache-Control max-age=900;

    # X-Robots-Tag header to be removed from config on "prod" only!
    add_header X-Robots-Tag noindex;

    include /etc/nginx/partials/internal_redirects.conf;
    rewrite ^/es$ /es/ permanent; # special; cannot be applied to the CMS because Drupal redirects /es/ to /es

    include /etc/nginx/partials/s3proxy.conf;
    include /etc/nginx/partials/404s.conf;
    include /etc/nginx/partials/staticsite.conf;
}
