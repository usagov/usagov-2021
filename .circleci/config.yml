version: 2.1
commands:
  deploy-cloudgov:
    parameters:
      envname:
        default: ""
        type: string
      tag:
        default: ""
        type: string
    steps:
      - checkout
      - run:
          name: Setup Environment for use in Scripts
          command: |
            if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi
            printenv | grep -i -v -E "^(PWD|OLDPWD|SHLVL|_)=" | sed -e 's/^\([^=]*=\)\(.*\)/export \1"\2"/' | $SUDO tee ./bin/cloudgov/env
      - run:
          name: Install CloudFoundry
          command: |
            #curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'
            #curl -v -L -o cf-cli_amd64.deb 'https://packages.cloudfoundry.org/stable?release=debian64&source=github-rel'
            curl -v -L -o cf-cli_amd64.deb 'https://packages.cloudfoundry.org/stable?release=debian64&version=7.3.0&source=github-rel'
            sudo dpkg -i cf-cli_amd64.deb
            cf -v
      - run:
          name: CloudGov Login
          command: |
            if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi
            echo "./bin/cloudgov/login $CF_USER $CF_PASS"
            echo "./bin/cloudgov/use-space << parameters.envname >>"
      - run:
          name: CloudGov deploy
          no_output_timeout: 30m
          command: |
            if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi
            echo "./bin/cloudgov/deploy"
            
jobs:
  lint:
    docker:
      - image: circleci/php:8.0.9-node
    steps:
      - checkout
      - run:
          name: Install Linters and Sniffers
          command: |
            cd /home/circleci/project/wwwroot/themes/custom/prac && npm install
            composer global require --dev drupal/coder php-parallel-lint/php-parallel-lint
            COMPOSER_DIR=$(composer -n config --global home)
            $COMPOSER_DIR/vendor/bin/phpcs --config-set installed_paths $COMPOSER_DIR/vendor/drupal/coder/coder_sniffer
      - run:
          name: PHP Lint
          command: |
            COMPOSER_DIR=$(composer -n config --global home)
            $COMPOSER_DIR/vendor/bin/parallel-lint -e php,module,inc,install,test,profile,theme ./wwwroot/modules/custom ./wwwroot/themes/custom
      - run:
          name: PHP CodeSniff (ignore warnings)
          command: |
            COMPOSER_DIR=$(composer -n config --global home)
            $COMPOSER_DIR/vendor/bin/phpcs -ns --standard=./.phpcs.xml.dist
      - run:
          name: Theme Lint
          command: cd /home/circleci/project/web/themes/custom/usagov && node /home/circleci/project/web/themes/custom/usagov/node_modules/gulp/bin/gulp.js lint

  build-container-dependencies:
    docker:
      - image: circleci/php:8.0.9-node
    steps:
      - checkout
      - run:
          name: Build Drupal
          command: |
            echo 'memory_limit = -1' | sudo tee -a /usr/local/etc/php/conf.d/docker-php-memlimit.ini
            echo "sudo npm install --global gulp-cli"
            echo "COMPOSER_MEMORY_LIMIT=-1 composer install --ignore-platform-reqs --no-interaction --no-progress --optimize-autoloader"
            echo "npm install --prefix ./web/themes/custom/usagov"
            echo "npm rebuild node-sass --prefix ./web/themes/usagov"
            echo "npm run build --prefix ./web/themes/custom/usagov"
            echo "if [ -d ./web/themes/usagov/node_modules ]; then"
            echo "    echo \"Removing Node Modules\""
            echo "    rm -rf ./web/themes/usagov/node_modules"
            echo "fi"
            echo "if [ -f ./web/sites/default/settings.local.php ]; then"
            echo "    echo \"Removing Local Settings File\""
            echo "    rm -f  ./web/sites/default/settings.local.php"
            echo "fi"
            echo "if [ -f ./web/sites/development.sevices.yml ]; then"
            echo "    echo \"Removing Development Services File\""
            echo "    rm -f  ./web/sites/development.sevices.yml"
            echo "fi"
      - persist_to_workspace:
          root: ./
          paths:
            - vendor
            - composer.lock
            - web/themes/custom/usagov/css

  create-container:
    machine:
     image: ubuntu-2004:202107-02
    environment:
      BASH_ENV: $CIRCLE_WORKING_DIRECTORY/bin/cloudgov/env
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Import Workspace items
          command: |
            echo "mkdir -p ./vendor/"
            echo "mkdir -p ./web/themes/custom/usagov/"
            echo "cp -r /tmp/workspace/vendor/* ./vendor/"
            echo "cp -r /tmp/workspace/composer.lock ./composer.lock"
            echo "cp -r /tmp/workspace/web/themes/custom/usagov/css/* ./web/themes/custom/usagov/css/"
      - setup_remote_docker:
        version: 19.03.13
      - run:
          name: Setup Environment for use in Scripts
          command: |
            if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi
            printenv | grep -i -v -E "^(PWD|OLDPWD|SHLVL|_)=" | sed -e 's/^\([^=]*=\)\(.*\)/export \1"\2"/' | $SUDO tee ./bin/cloudgov/env
      - run:
          name: Login to Docker Hub
          no_output_timeout: 30m
          command: |
            if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi
            echo "echo $DOCKERHUB_ACCESS_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin"
      - run:
          name: Build Container
          no_output_timeout: 30m
          command: |
            if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi
            echo "./bin/cloudgov/container-build << pipeline.id >>"
      - run:
          name: Push Container to Docker Hub
          no_output_timeout: 30m
          command: |
            if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi
            echo "./bin/cloudgov/container-push << pipeline.id >>"

  deploy-cloudgov-prod:
    machine:
      image: ubuntu-2004:202101-01
    environment:
      BASH_ENV: $CIRCLE_WORKING_DIRECTORY/bin/cloudgov/env
    steps:
      - deploy-cloudgov:
          envname: prod

workflows:
  version: 2

  commit:
    jobs:
      - lint

  deploy-build:
    jobs:
      - build-container-dependencies:
          filters:
            branches:
              only: buildservers
      - approve-create-container:
          type: approval
          requires:
            - build-container-dependencies
          filters:
            branches:
              only: buildservers
      - create-container:
          requires:
            - approve-create-container
          filters:
            branches:
              only: buildservers
      - approve-prod-deployment:
          type: approval
          requires:
            - build-container-dependencies
          filters:
            branches:
              only: buildservers
      - deploy-cloudgov-prod:
          requires:
            - approve-prod-deployment
          filters:
            branches:
              only: buildservers