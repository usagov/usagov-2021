{#
/**
 * @file
 * Theme override for a view template to display a list of rows.
 *
 * Available variables:
 * - attributes: HTML attributes for the container.
 * - rows: A list of rows for this list.
 *   - attributes: The row's HTML attributes.
 *   - content: The row's contents.
 * - title: The title of this group of rows. May be empty.
 * - list: @todo.
 *   - type: Starting tag will be either a ul or ol.
 *   - attributes: HTML attributes for the list element.
 *
 * @see template_preprocess_views_view_list()
 */
#}

{% set lang = node.langcode.value %}
{% set term_name = "" %}
{% if node.field_page_type.0 != null %}
    {% set term_name = drupal_field('name', 'taxonomy_term', node.field_page_type.0.target_id)[0]['#context']['value'] %}
{% endif %}


{#
  Loop through:
    - Child Pages (rows)
    - Related Pages (node.field_related_pages)
  Collect info:
    - relationship
    - url
    - title
    - intro
  Group into 2 arrays
    - relatedPages
    - childPages
  Keep track of proccessed Node IDs to avoid displaying duplicate items
#}
{% set relatedPages = [] %}
{% set remainingPages = [] %}
{% set processedNodeIDs = [] %}

{% for page in node.field_related_pages %}
  {% set relatedPages = relatedPages|merge([{
    relationship:  "RelatedPage",
    url:  drupal_url('node/'~page.target_id),
    title: drupal_field('title', 'node', page.target_id)[0]["#context"].value,
    intro: drupal_field('field_page_intro', 'node', page.target_id)[0]
  }]) %}
  {% set processedNodeIDs = processedNodeIDs|merge([page.target_id]) %}
{% endfor %}

{% for page in rows %}
  {% set nodeID = page.content["#row"].nid %}
  {% if nodeID not in processedNodeIDs %}
    {# {% set title = drupal_field('title', 'node', nodeID) %}
    {% set intro = drupal_field('field_page_intro', 'node', nodeID) %} #}
    {% set remainingPages = remainingPages|merge([{
      relationship:  "ChildPage",
      url:  drupal_url('node/' ~ page.content["#row"].nid),
      title: drupal_field('title', 'node', nodeID)[0]["#context"].value,
      intro: drupal_field('field_page_intro', 'node', nodeID)[0]["#context"].value
    }]) %}
    {% set processedNodeIDs = processedNodeIDs|merge([nodeID]) %}
  {% endif %}
{% endfor %}



{% if term_name == "Navigation Page" %}

  <ul class="usa-list usa-list--unstyled">
    {% for item in relatedPages %}
      {% include "@usagov/NavPageListItem.twig" with {'item': item} %}
    {% endfor %}
    {% for item in remainingPages %}
      {% include "@usagov/NavPageListItem.twig" with {'item': item} %}
    {% endfor %}
  </ul>

{% elseif term_name == "Navigation Cards Page" %}

  <div class="usagov-cards margin-top-3">
    <ul class="usa-card-group">
      {% for item in featuredPages %}
        {% include "@usagov/NavPageCard.twig" with {'item': item} %}
      {% endfor %}
      {% for item in remainingPages %}
        {% include "@usagov/NavPageCard.twig" with {'item': item} %}
      {% endfor %}
    </ul>
  </div>

  {% if lang == "en" %}
    <p><span class="text-bold">Looking for something else?</span> <a href="/">Explore All Topics and Services</a></p>
  {% else %}
    <p><span class="text-bold">¿Busca algo más? <a href="/es">Encuentre más temas y servicios</a></span></p>
  {% endif %}

{% endif %}



{% if view.current_display == "block_4" %}
  {# block_4 is the intro_page display for this view which is used on the homepage #}
  <div class="usagov-cards">
    <ul class="usa-card-group">
      {% for row in rows %}

        {% set css_icon = row.content["#row"].node__field_css_icon_field_css_icon_value %}
        {% if css_icon == null %}
          {% set css_icon = "" %}
        {% else %}
          {% set css_icon = "topic-icon " ~ css_icon %}
        {% endif %}
        <li class="tablet:grid-col-6 usa-card">
          <a href="{{ drupal_url('node/' ~ row.content["#row"].nid) }}" class="usa-card__container usagov-card text-no-underline {{css_icon}}">
            {{- row.content -}}
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>


  {% if lang == "en" %}
    <p><span class="text-bold">Looking for our main site?</span> Visit <a href="https://www.usa.gov">USA.gov</a></p>
  {% elseif lang == "es" %}
    <p><span class="text-bold">¿Busca nuestro sitio web principal?</span> Visite <a href="https://www.usa.gov/espanol/">USA.gov/espanol</a></p>
  {% endif %}
{% endif %}
