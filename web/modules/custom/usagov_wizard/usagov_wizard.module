<?php

use Drupal\Core\Url;
use Drupal\usagov_wizard\MenuChecker;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Alter the form by adding a "View Term" button
 * if the form is the taxonomy_term_wizard_form.
 */
function usagov_wizard_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'taxonomy_term_wizard_form') {
    if (isset($form['tid'])) {
      $form['actions']['link_to_term'] = [
        '#title' => t('View Term'),
        '#type' => 'link',
        '#url' => Url::fromUri('base:/taxonomy/term/' . $form['tid']["#value"]),
        '#attributes' => [
          'class' => [
            'button',
            'usa-button'
          ],
        ],
        '#weight' => 10,
      ];
    }
  }
}

/**
 * Implements hook_theme_suggestions_alter().
 */
function usagov_wizard_theme_suggestions_page_alter(array &$suggestions, array &$variables) {
$taxonomy_term = \Drupal::routeMatch()->getParameter('taxonomy_term');
  if ($taxonomy_term instanceof \Drupal\taxonomy\Entity\Term) {
    $suggestions[] = 'page__taxonomy__term__' . $taxonomy_term->vid->getValue()[0]['target_id'];
  }
}

function usagov_wizard_preprocess_page(&$variables) {
  $taxonomy_term = \Drupal::routeMatch()->getParameter('taxonomy_term');
  if ($taxonomy_term instanceof \Drupal\taxonomy\Entity\Term) {
    $menuChecker = \Drupal::classResolver(MenuChecker::class);
    $termParents = $menuChecker->getTermParents($taxonomy_term);
    $menuEntities = $menuChecker->getTargetEntities('left-menu-english');

    $matching_tid = array_intersect($termParents, $menuEntities['target_tids']);
    $matching_tid = implode(',', $matching_tid);
    if (isset($matching_tid)) {
      foreach ($menuEntities['menu_entities'] as $menuEntity) {
        $variables['menu_entities'] = array_map(function($menuEntity) {
          return [
            'label' => $menuEntity->title->value,
            'link' => Url::fromUri($menuEntity->link->uri)->toString(),
          ];
        }, $menuEntities['menu_entities']);
      }
    }
  }
}
