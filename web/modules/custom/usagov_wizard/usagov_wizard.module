<?php

/**
 * @file
 * Hooks for hogwarts.
 *
 * Send variables to the wizard breadcrumbs and page twig,
 * create new theme suggestions, and alter the form.
 */

use Drupal\Core\Url;
use Drupal\taxonomy\Entity\Term;
use Drupal\usagov_wizard\MenuChecker;

/**
 * Implements hook_form_alter().
 *
 * Alter the form by adding a "View Term" button
 * if the form is the taxonomy_term_wizard_form.
 */
function usagov_wizard_form_taxonomy_term_wizard_form_alter(&$form, &$form_state) {
  if (isset($form['tid'])) {
    $url = Url::fromUri('base:' .
      ($form['langcode']['widget'][0]['value']['#default_value'] == 'en' ? '' : 'es/')
      . 'taxonomy/term/' . $form['tid']["#value"]);

    $form['actions']['link_to_term'] = [
      '#title' => t('View Term'),
      '#type' => 'link',
      '#url' => $url,
      '#attributes' => [
        'class' => [
          'button',
          'usa-button',
        ],
      ],
      '#weight' => 10,
    ];
  }
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * Check the field_tracking boolean, send information to twig if set to true.
 * Use this to determine whether to display crazyegg tracking script.
 */
function usagov_wizard_preprocess_html(&$variables) {
  if (\Drupal::routeMatch()->getRouteName() == 'entity.taxonomy_term.canonical') {
    $taxonomy_term = \Drupal::routeMatch()->getParameter('taxonomy_term');
    if (isset($taxonomy_term->field_header_html)) {
      if (isset($taxonomy_term->field_header_html->value)) {
        $variables['header_html'] = $taxonomy_term->field_header_html->value;
      }
    }
  }
}

/**
 * Implements hook_theme_suggestions_alter().
 */
function usagov_wizard_theme_suggestions_page_alter(array &$suggestions, array &$variables) {
  $taxonomy_term = \Drupal::routeMatch()->getParameter('taxonomy_term');
  if ($taxonomy_term instanceof Term) {
    $suggestions[] = 'page__taxonomy__term__' . $taxonomy_term->vid->getValue()[0]['target_id'];
  }
}

/**
 * Implements hook_theme_suggestions_alter().
 */
function usagov_wizard_theme_suggestions_breadcrumb_alter(array &$suggestions, array &$variables) {
  $taxonomy_term = \Drupal::routeMatch()->getParameter('taxonomy_term');
  if ($taxonomy_term instanceof Term) {
    $suggestions[] = 'breadcrumb__' . $taxonomy_term->vid->getValue()[0]['target_id'];
  }
}

/**
 * Implements hook_theme_suggestions_alter().
 *
 * Custom region_header_top so we can have a custom mobile nav menu generated
 * from MenuChecker.php.
 */
function usagov_wizard_theme_suggestions_region_alter(array &$suggestions, array &$variables) {
  $taxonomy_term = \Drupal::routeMatch()->getParameter('taxonomy_term');
  if ($taxonomy_term instanceof Term) {
    $suggestions[] = 'region__' . $variables['elements']['#region'] . '_' . $taxonomy_term->vid->getValue()[0]['target_id'];
  }
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * Preprocess the page by retrieving information about the taxonomy term,
 * checking its parent terms, and matching it with menu entities.
 * The matched menu entities are then sorted by weight and added to the page
 * variables.
 */
function usagov_wizard_preprocess_page(&$variables) {
  $taxonomy_term = \Drupal::routeMatch()->getParameter('taxonomy_term');
  if ($taxonomy_term instanceof Term) {
    if ($taxonomy_term->bundle() === 'wizard') {
      $menuChecker = \Drupal::classResolver(MenuChecker::class);

      // Get an array of the current taxonomy term and all of its parents.
      $termParents = $menuChecker->getTermParents($taxonomy_term);
      $langcode = $variables['language']->getId();

      // Check the menu based on langcode for links to taxonomy terms.
      $menuEntities = $menuChecker->getTargetEntities($langcode);

      // See if there are any matches.
      if (isset($menuEntities['target_tids'])) {
        $matching_tid = array_intersect($termParents, $menuEntities['target_tids']);

        $matching_tid = implode(',', $matching_tid);

        // If there are matches, send them to the twig.
        if (isset($matching_tid)) {
          foreach ($menuEntities['menu_entities'] as $menuEntity) {
            $entities = array_map(function ($menuEntity) {
              return [
                'label' => $menuEntity->title->value,
                'link' => Url::fromUri($menuEntity->link->uri)->toString(),
                'weight' => $menuEntity->getWeight(),
              ];
            }, $menuEntities['menu_entities']);

            usort($entities, function ($item1, $item2) {
              return $item1['weight'] <=> $item2['weight'];
            });

            $variables['menu_entities'] = $entities;
            $variables['page']['header_top']['#menu_entities'] = $entities;
          }
        }
      } // End isset $menuEntities['target_tids']

      if (isset($taxonomy_term->field_language_toggle[0]->target_id)) {
        $variables['translation'] = $taxonomy_term->field_language_toggle->getValue()[0]['target_id'];
      }
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * Determine where the current page sits in the taxonomy hierarchy and send this
 * information to the twig so we can decide which of the "previous, next, start
 * over' buttons/links to show.
 */
function usagov_wizard_preprocess_taxonomy_term(&$variables) {
  if ($variables['term']->bundle() == 'wizard') {
    $parent_tid = $variables['term']->hasField('parent') ? $variables['term']->get('parent')->target_id : NULL;
    $variables['parent_tid'] = $parent_tid;

    /* If there's a parent_tid, this is a child page.
     * In the twig, use this information to decide whether to display the
     * previous button. Use the url from the $parent_tid to set the path in that
     * button
     */

    if ($parent_tid) {
      $variables['child'] = TRUE;
    }
    else {
      $variables['child'] = FALSE;
    }

    $menuChecker = \Drupal::classResolver(MenuChecker::class);
    $parents = $menuChecker->getTermParents($variables['elements']['#taxonomy_term']);

    /*
     * Get an array of all the term's parents. Check the last loop of the array.
     * This is the root of the tree. Set the $root_tid to equal $parent. If the
     * page we are on is not the root of the tree (parent_tid != root_tid) and
     * the page we are on is not the root itself, tell the twig to show the
     * start_over link.
     *
     * Finally, check the second to last loop of the array.
     * The url for the start_over link should be the tid of this loop.
     */
    $counter = 0;
    foreach ($parents as $parent) {
      if ($counter == count($parents) - 1) {
        $root_tid = $parent;
        if ($parent_tid != $root_tid && $root_tid != $variables['term']->id()) {
          $variables['start_over'] = 'true';

        }
        else {
          $variables['start_over'] = 'false';
        }
      }
      elseif ($counter == count($parents) - 2) {
        $variables['start_over_target_tid'] = $parent;
      }
      $counter = $counter + 1;
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * Breadcrumbs should have a structure like this: “Home -> Parent left nav menu
 * link -> Name of first wizard page. In the current setup this would be
 * “Home -> How to report a scam -> USA.gov where to report a scam tool”.
 * This breadcrumb setup should not change throughout the wizard.
 *
 * By default, breadcrumbs are set up to utilize the term name. This needs to be
 * altered in a couple of ways.
 *
 * For one, the second item in the breadcrumb, "How to report a scam", should be
 * the text of the menu entity, so the menu needs to be hooked up to the
 * breadcrumb similarly to how it was done for the left nav.
 *
 * For another thing, the third item in the breadcrumb "USA.gov where to report
 * a scam tool", should be the field_heading of that term, not the name.
 * This will need to be accomplished in a preprocess hook.
 */
function usagov_wizard_preprocess_breadcrumb(&$variables) {
  $taxonomy_term = \Drupal::routeMatch()->getParameter('taxonomy_term');
  if ($taxonomy_term instanceof Term) {
    if ($taxonomy_term->bundle() == 'wizard') {
      $menuChecker = \Drupal::classResolver(MenuChecker::class);
      $langcode = $taxonomy_term->langcode->value;

      $parent_headings = $menuChecker->getHeadings($taxonomy_term);
      $menuEntities = $menuChecker->getTargetEntities($langcode);

      if (isset($menuEntities['menu_entities'])) {
        // If there's a custom parent menu entity...
        foreach ($menuEntities['menu_entities'] as $menuEntity) {
          if ($menuEntity->field_custom_parent->value == 1) {
            $wizard_title = $menuEntity->title->value;
          }
        }
      }

      // Use that to determine the second item in the breadcrumb.
      if (isset($wizard_title)) {
        $variables['breadcrumb']['1']['text'] = $wizard_title;

        /*
         *  And, if we are on the page that corresponds with the second item,
         *  remove that page from the array.
         */
        if (isset($variables['breadcrumb']['2'])) {
          if ($variables['breadcrumb']['2']['text'] == $wizard_title) {
            unset($variables['breadcrumb']['1']);
            unset($variables['breadcrumb']['2']);
          }
        }
      }
      $i = 0;
      // Set the third item in the breadcrumb to be the field_heading.
      foreach ($variables['breadcrumb'] as &$breadcrumb) {

        /* Dont do anything to the second breadcrumb, since this one has a weird
        naming system. */
        if ($i++ == 1) {
          continue;
        }
        foreach ($parent_headings as $parent_heading) {
          if (is_string($breadcrumb['text']) && $parent_heading['name'] ===
            $breadcrumb['text']) {
            $breadcrumb['text'] = $parent_heading['label'];
          }
        }
      }
    }
  }
}
